<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>图像处理</title>


</head>
<script>
    //自动识别切割
    function dateFormat(fmt, date) {
        let ret;
        const opt = {
            "Y+": date.getFullYear().toString(),        // 年
            "m+": (date.getMonth() + 1).toString(),     // 月
            "d+": date.getDate().toString(),            // 日
            "H+": date.getHours().toString(),           // 时
            "M+": date.getMinutes().toString(),         // 分
            "S+": date.getSeconds().toString()          // 秒
            // 有其他格式化字符需求可以继续添加，必须转化成字符串
        };
        for (let k in opt) {
            ret = new RegExp("(" + k + ")").exec(fmt);
            if (ret) {
                fmt = fmt.replace(ret[1], (ret[1].length == 1) ? (opt[k]) : (opt[k].padStart(ret[1].length, "0")))
            };
        };
        return fmt;
    }
    var current = new Date()
    let now = dateFormat("YYYY-mm-dd HH:MM:SS", current)

    var imageList = ['qian']

    //建设银行
    var amount = { sw: 65, sh: 376 }
    var suffix = ".jpg", digist = "3,309,495.10".match(/./g), prefix = '1/'
    var flag = true//整数位上的0

    digist.forEach(item => {
        if (flag && item == '0') {
            imageList.push("40_0")
            return
        }
        if (item == ',') {
            item = 'dou'
        }

        if (item == '.') {
            item = 'dian'
            flag = false
        }
        imageList.push(item)
    })
    //系统顶部消息
    if (current.getHours() >= 12) {
        current.setHours(current.getHours() - 12)
    }

    var sys_time = dateFormat("HH:MM", current)
    for (let i = 0; i < sys_time.length; i++) {
        const e = sys_time[i] == ':' ? 'mao' : sys_time[i];
        imageList.push(e)
    }
    var sys_point = { sw: 46, sh: 26 }

    //建设银行时间点
    for (let i = 0; i < now.length; i++) {
        const e = now[i] == '-' ? 'pie' : now[i] == ':' ? 'mao' : now[i];
        if (e != ' ') {
            imageList.push(e)
        }

    }

    var date = { sw: 67, sh: 558 }
    var time = { sw: 307, sh: 558 }
    //开始位置
    var sw = amount.sw, sh = amount.sh

    //变动位置
    var k = imageList.length - digist.length - 1
    function drawAndShareImage() {
        var canvas = document.createElement("canvas");

        var context = canvas.getContext("2d");

        var myImage = new Image();
        myImage.src = prefix + "./main" + suffix;    //背景图片  你自己本地的图片或者在线图片
        myImage.crossOrigin = 'Anonymous';

        var up = new Image();
        up.src = prefix + "./up" + suffix;    //背景图片  你自己本地的图片或者在线图片
        up.crossOrigin = 'Anonymous';

        var battery = new Image();
        battery.src = prefix + "battery/2" + suffix;    //背景图片  你自己本地的图片或者在线图片
        battery.crossOrigin = 'Anonymous';

        function loadImage(imageList) {
            if (imageList.length == 0) {
                var base64 = canvas.toDataURL("image/png");  //"image/png" 这里注意一下
                var img = document.getElementById('avatar');

                document.getElementById('avatar').src = base64;
                img.setAttribute('src', base64);
                return
            }
            if (imageList.length == k) {
                sw = sys_point.sw
                sh = sys_point.sh
                prefix = '1/sys/'
            }

            if (imageList.length == 18) {
                sw = date.sw
                sh = date.sh
                prefix = '1/time/'
            } else if (imageList.length == 8) {
                sw = time.sw
                sh = time.sh
                prefix = '1/time/'
            }

            var item = imageList.shift()
            var image = new Image();
            image.src = prefix + item + suffix
            image.onload = () => {
                context.drawImage(image, sw, sh);
                sw += image.width + (prefix == '1/time/' ? 3 : 0)
                loadImage(imageList)
            }
        }

        var other = ["qq","wx"].map(item => {
            var otherImage = new Image()
            otherImage.src = "1/other/" + item + suffix;
            // otherImage.crossOrigin = 'Anonymous';
            return otherImage
        })

        myImage.onload = function () {
            canvas.width = myImage.width;
            canvas.height = myImage.height;
            context.drawImage(myImage, 0, 0);
            context.drawImage(up, 826, 21);
            context.drawImage(battery, 826 + up.width, 21);
            var otherWidth = 163
            for (let i = 0; i < other.length; i++) {
                const e = other[i];
                context.drawImage(e, otherWidth, 20);
                otherWidth += e.width + 16
            }
            // context.font = "Courier New";
            // context.fillText(sys_time, 45, 26);
            loadImage(imageList)
        }
    }
    drawAndShareImage()


</script>

<body>
    <img id="avatar" alt="">
    <canvas id="canvas"></canvas>

</body>

</html>